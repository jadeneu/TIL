# 목차
* [Token](#token)
* [토큰을 사용하게 된 이유](#토큰을-사용하게-된-이유)
  + [서버 기반 인증](#서버-기반-인증)
  + [서버 기반 인증의 문제점](#서버-기반-인증의-문제점)
    - [세션](#세션)
    - [확장성](#확장성)
    - [CORS (Cross-Origin Resource Sharing)](#cors-cross-origin-resource-sharing)
* [토큰 기반 시스템의 작동 원리](#토큰-기반-시스템의-작동-원리)
* [토큰의 장점](#토큰의-장점) 
* [번외. 로그인할 때 토큰이란?](#번외-로그인할-때-토큰이란)
---
* [출처](#출처)
<br><br><br>


# Token
토큰(Token) 기반 인증은 모던 웹서비스에서 많이 사용되고 있다. 우리가 API를 사용하는 웹서비스를 개발한다면, 토큰을 사용하여 유저들의 인증작업을 처리하는것이 가장 좋은 방법이다.

토큰 기반 인증 시스템을 선택하는데에는 여러가지 이유가 있는데, 그 중 주요 이유들은 다음과 같다.
<br><br>
### 1. Stateless 서버
Stateless 서버를 이해하려면 먼저 **Stateful** 서버가 무엇인지 알아야한다.<br>
Stateful 서버는 클라이언트에게서 요청을 받을 때 마다 클라이언트의 상태를 계속해서 유지하고, 이 정보를 서비스 제공에 이용한다.

stateful 서버의 예제로는 세션을 유지하는 웹서버가 있다.<br>
예를들어 유저가 로그인을 하면 세션에 로그인이 되었다고 저장을 해 두고, 서비스를 제공 할 때에 그 데이터를 사용하는 것이다.<br>
여기서 이 세션은 서버컴퓨터의 메모리에 담을 때도 있고, 데이터베이스 시스템에 담을 때도 있다.

**Stateless 서버는 반대로, 상태를 유지 하지 않는다.**<br>
상태 정보를 저장하지 않으면, 서버는 클라이언트측에서 들어오는 요청만으로만 작업을 처리한다.<br>
이렇게 상태가 없는 경우 클라이언트와 서버의 연결고리가 없기 때문에 서버의 확장성(Scalability)이 높아진다.
<br><br>

### 2. 모바일 어플리케이션에 적합하다
만약에 Android / iOS 모바일 어플리케이션을 개발 한다면, 안전한 API를 만들기 위해선 쿠키같은 인증시스템은 이상적이지 않다. (쿠키 컨테이너를 사용해야함)<br>
토큰 기반 인증을 도입한다면, 더욱 간단하게 이 번거로움을 해결 할 수 있다.
<br><br>

### 3. 인증정보를 다른 어플리케이션으로 전달
대표적인 예제로는, OAuth 가 있다.<br>
페이스북/구글 같은 소셜 계정들을 이용하여 다른 웹서비스에서도 로그인 하게 할 수 있다.
<br><br>

### 4. 보안
토큰 기반 인증 시스템을 사용하여 어플리케이션의 보안을 높일 수 있다.<br>
단, 이 토큰 기반 인증을 사용한다고 해서 무조건 해킹의 위험에서 벗어나는건 아니다.
<br><br><br>

# 토큰을 사용하게 된 이유
토큰 기반 인증 시스템이 어떻게 나타났는지 알아보자.<br>
이를 위해서는 과거의 인증시스템이 어떤 방식으로 작동했는지 살펴볼 필요가 있다.
<br><br>

## 서버 기반 인증
기존의 인증 시스템에서는 서버측에서 유저들의 정보를 기억하고 있어야한다.<br>
이 세션을 유지하기 위해서는 여러가지 방법이 사용된다.<br>
메모리 / 디스크 / 데이터베이스 시스템에 이를 담곤 한다.

서버 기반 인증 시스템의 흐름을 보자면 다음과 같다.

<img src="https://user-images.githubusercontent.com/55045377/125162029-b74a4380-e1c0-11eb-95d9-408b0cf25828.png" width=50% height=50%>

이런 방식의 인증 시스템은 아직도 많이 사용 되고 있다.<br>
하지만 요즘 웹 / 모바일 웹 어플리케이션들이 부흥하게 되면서 이런 방식의 인증 시스템은 문제를 보이기 시작했는데, 예를 들면 서버를 확장하기가 어려워진 것이다.
<br><br>

## 서버 기반 인증의 문제점
### 세션
유저가 인증을 할 때 서버는 이 기록을 서버에 저장을 해야한다. 이를 세션이라고 부른다.<br>
대부분의 경우엔 메모리에 이를 저장하는데, 로그인 중인 유저의 수가 늘어난다면 어떻게 될까? 서버의 램이 과부화가 될 것이다.<br>
이를 피하기 위해 세션을 데이터베이스 시스템에 저장하는 방식도 있지만, 이 또한 유저의 수가 많으면 데이터베이스의 성능에 무리를 줄 수 있다.
<br><br>

### 확장성
세션을 사용하면 서버를 확장하는것이 어려워진다.<br>
여기서 서버의 확장이란, 단순히 서버의 사양을 업그레이드 하는것이 아니라 더 많은 트래픽을 감당하기 위하여 여러개의 프로세스를 돌리거나, 여러대의 서버 컴퓨터를 추가하는것을 의미한다.<br>
세션을 사용하면서 분산된 시스템을 설계하는건 불가능한 것은 아니지만 과정이 매우 복잡해진다.
<br><br>

### CORS (Cross-Origin Resource Sharing)
웹 어플리케이션에서 세션을 관리 할 때 자주 사용되는 쿠키는 단일 도메인 및 서브 도메인에서만 작동하도록 설계되어있다.<br>
따라서 쿠키를 여러 도메인에서 관리하는것은 번거롭다.
<br><br><br>

# 토큰 기반 시스템의 작동 원리
토큰 기반 시스템은 stateless 하다.<br>
무상태, 즉 상태유지를 하지 않는다는 것이다.<br>
이 시스템에서는 더 이상 유저의 인증 정보를 서버나 세션에 담아두지 않는다.<br>
이 개념 하나만으로도 위에서 서술한, 서버에서 유저의 인증 정보를 서버측에 담아둠으로써 발생하는 많은 문제점들이 해소된다.

세션이 존재하지 않으니, 유저들이 로그인 되어있는지 안 되어있는지 신경 쓰지 않으면서 서버를 손쉽게 확장 할 수 있을 것이다.

토큰 기반 시스템의 구현 방식은 시스템마다 크고 작은 차이가 있겠지만, 대략적으로 보면 다음과 같다:
1. 유저가 아이디와 비밀번호로 **로그인**을 한다.
2. 서버측에서 해당 **계정정보를 검증**한다.
3. 계정정보가 정확하다면, 서버측에서 유저에게 **signed 토큰을 발급**해준다.<br>
여기서 signed 의 의미는 해당 토큰이 서버에서 정상적으로 발급된 토큰임을 증명하는 signature 를 지니고 있다는 것이다.
4. 클라이언트 측에서 전달받은 **토큰을 저장**해두고, 서버에 요청을 할 때 마다 해당 **토큰을 함께 서버에 전달**한다.
5. 서버는 **토큰을 검증**하고, **요청에 응답**한다.
<br>

<img src="https://user-images.githubusercontent.com/55045377/125250252-fac3bf80-e330-11eb-947b-8fcc17997553.png" width=50% height=50%>

웹서버에서 토큰을 서버에 전달 할 때에는, HTTP 요청의 헤더에 토큰값을 포함시켜서 전달한다.
<br><br><br>

# 토큰의 장점
### 무상태(stateless) 이며 확장성(scalability)이 있다
이 개념에 대해선 지금 반복적으로 이야기하고 있다. 이는 그만큼 토큰 기반 인증 시스템의 중요한 속성이다.<br>
토큰은 **클라이언트 사이드**에 저장하기 때문에 완전히 stateless 하며, 서버를 확장하기에 매우 적합한 환경을 제공한다.<br>
만약에 세션을 서버측에 저장하고 있고 서버를 여러대를 사용하여 요청을 분산하였다면, 어떤 유저가 로그인 했을 때 그 유저는 처음 로그인했었던 그 서버에만 요청을 보내도록 설정을 해야한다.<br>
하지만 토큰을 사용한다면, 어떤 서버로 요청이 들어가든 상관이 없다.

* ***클라이언트 사이드(client-side)란 네트워크의 한 방식인 클라이언트-서버 구조의 클라이언트 쪽에서 행해지는 처리를 말한다.***<br><br>
   예) HTTP 통신에 있어서 브라우저의 주요 기능 중 하나는 서버에서 수신한 HTML 문서를 해석하여 화면에 표시해 주는 것인데, HTML 문서가 동적인 부분을 갖고 있지 않다면 문서 수신이 끝나고부터는 서버와 교신하지 않고 브라우저가 클라이언트 사이드에서 처리하여 화면에 내용을 표시한다.<br><br>
   예) MMORPG(대규모 다중 사용자 온라인 롤플레잉 게임)에서도 클라이언트-서버 구조가 사용된다. 대부분의 MMORPG는 화려한 그래픽 효과를 사용하는데 이를 위해서는 많은 연산이 필요하며 이러한 연산을 서버 쪽에서 모두 부담할 수 없으므로 그래픽 처리나 소리 처리의 대부분을 클라이언트 사이드로 처리한다.
   
   출처 : https://ko.wikipedia.org/wiki/%ED%81%B4%EB%9D%BC%EC%9D%B4%EC%96%B8%ED%8A%B8_%EC%82%AC%EC%9D%B4%EB%93%9C  
<br>

### 보안성
클라이언트가 서버에 요청을 보낼 때, 더 이상 쿠키를 전달하지 않음으로 쿠키를 사용함으로 인해 발생하는 취약점이 사라진다.<br>
하지만 토큰을 사용하는 환경에서도 취약점이 존재 할 수 있으니 언제나 취약점에 대비해야 한다.
<br><br>

### Extensibility (확장성)
여기서의 확장성은 Scalability 와는 또 다른 개념이다.<br>
Scalability 는 서버를 확장하는걸 의미하는 반면, Extensibility 는 로그인 정보가 사용되는 분야를 확장하는 것을 의미한다.<br>
토큰을 사용하여 다른 서비스에서도 권한을 공유 할 수 있다.<br>
예를 들어서, 스타트업 구인구직 웹서비스인 로켓펀치에서는 Facebook, LinkedIn, GitHub, Google 계정으로 로그인을 할 수 있다.<br>
토큰 기반 시스템에서는 토큰에 선택적인 권한만 부여하여 발급을 할 수 있다 (예를 들어 로켓펀치에서 페이스북 계정으로 로그인을 했다면, 프로필 정보를 가져오는 권한은 있어도 포스트를 작성할 수 있는 권한은 없다)
<br><br>

### 여러 플랫폼 및 도메인
서버 기반 인증 시스템의 문제점을 다룰 때 CORS 에 대하여 언급 했었다.<br>
어플리케이션과 서비스의 규모가 커지면 우리는 여러 디바이스를 호환 시키고, 더 많은 종류의 서비스를 제공하게 된다.<br>
토큰을 사용한다면 그 어떤 디바이스에서도, 그 어떤 도메인에서도 토큰만 유효하다면 요청이 정상적으로 처리 된다.<br>
서버측에서 어플리케이션의 응답부분에 다음 헤더만 포함시켜주면 된다.
```
Access-Control-Allow-Origin: *
```
이런 구조라면 assets 파일들(이미지, css, js, html 파일 등)은 모두 CDN 에서 제공을 하도록 하고, 서버측에서는 오직 API만 다루도록 하도록 설계 할 수도 있다.
<br><br>

### 웹 표준 기반
토큰 기반 인증 시스템의 구현체인 JWT는 웹 표준 RFC 7519 에 등록이 되어있다.<br>
따라서 여러 환경에서 지원이 되며 (.NET, Ruby, Java, Node.js, Python, PHP …) 수많은 회사의 인프라 스트럭쳐에서 사용되고 있다. (구글, 마이크로소프트...)
<br><br><br>

# 번외. 로그인할 때 토큰이란?
블록체인 암호화폐도 토큰이라는 말을 쓴다. 그러나 여기에서 다룰 것은 블록체인 토큰이 아니고 **로그인을 하거나 사이트를 이용할 때 토큰**이다.

토큰은 말 그대로 동전이란 뜻이다. (like 버스카드나 교통카드)<br>
그런데 동전하고는 조금 다르다.<br>
동전 처럼 생겼지만 시장에 가서 물건을 사거나 할 수는 없고, 버스를 탈 때 동전 대신 넣듯이 **토큰은 특정한 목적에만 사용할 수 있다.** (돈 보다는 바우처와 비슷!)

토큰은 일종의 권리를 주는 것이다. 버스를 탈 수 있는 권리, 지하철을 탈 수 있는 권리를 부여 해주는 것이다.<br>
이 권리를 받는 방법은 토큰의 경우 돈을 냈느냐 안냈느냐 이다.<br>
돈을 내면 토큰을 받고, 이 토큰을 내서 버스에 탈 수 있다.

토큰은 이미 없어진지 오래 되었고 동전도 점점 없어지고 있어서 토큰의 의미를 직관적으로 이해하기가 어렵게 되었지만 의미 자체는 **'권리'** 이다.<br>
점점 이 토큰이라는 것이 우리 눈에 보이지 않게 클라이언트와 서버 간에 코드로 왔다갔다 하고 있는 것이 지금 기술의 발전 단계이다.
<br><br>

서버에서는 사용자가 결제한 돈도 왔다갔다 하기 때문에 '권한'이라는 것이 중요하다.<br>
인터넷에 사이트를 올리면 전 세계에서 접근 할 수 있기 때문에 사용자나 해커나 이 사이트에 접근을 할 수 있다.<br>
그래서 사용자들의 돈을 보호 하기 위해 본인만 돈을 넣거나 빼고 주문을 넣고 결제를 할 수 있게 만들어야 한다.<br>
이 토큰은 **본인 확인 수단**이다. 로그인을 할 때 id와 pw를 넣고 로그인을 하면 서버가 그것을 확인 해서 id와 pw가 맞으면 이 사용자가 유효한 사용자라는 토큰을 발행 해준다.<br>
그러면 사용자들은 이 토큰을 가지고 해당 사이트의 여러 버스에 해당하는 서비스들을 이용 할 수 있는 것이다.
<br><br><br>



























---
# 출처
* **Token [[Token](#token)]**<br>
  https://velopert.com/2350
* **토큰을 사용하게 된 이유 [[토큰을 사용하게 된 이유](#토큰을-사용하게-된-이유)]**<br>
  https://velopert.com/2350
* **토큰 기반 시스템의 작동 원리 [[토큰 기반 시스템의 작동 원리](#토큰-기반-시스템의-작동-원리)]**<br>
  https://velopert.com/2350
* **토큰의 장점 [[토큰의 장점](#토큰의-장점)]**<br>
  https://velopert.com/2350
* **번외. 로그인할 때 토큰이란? [[번외. 로그인할 때 토큰이란?](#번외-로그인할-때-토큰이란)]**<br>
  https://krksap.tistory.com/1586
<br><br>
